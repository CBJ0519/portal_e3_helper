# è‡ªå‹•æª¢æ¸¬åŠŸèƒ½é™¤éŒ¯ç¸½çµ - 2025-11-25

## ğŸ¯ å•é¡Œæ ¹æºå·²ç¢ºèª

ç¶“éè©³ç›¡çš„è¨ºæ–·èª¿æŸ¥ï¼Œæˆ‘å€‘ç¢ºèªäº†è‡ªå‹•æª¢æ¸¬ç¹³äº¤ç‹€æ…‹åŠŸèƒ½å¤±æ•ˆçš„**æ ¹æœ¬åŸå› **ï¼š

### API éŒ¯èª¤

```json
{
  "error": true,
  "exception": {
    "message": "ç¶²è·¯æœå‹™ç„¡æ³•ä½¿ç”¨(å®ƒä¸å­˜åœ¨æˆ–è€…å·²ç¶“åœç”¨)",
    "errorcode": "servicenotavailable",
    "link": "https://e3p.nycu.edu.tw/",
    "moreinfourl": "https://docs.moodle.org/405/zh_tw/error/webservice/servicenotavailable"
  }
}
```

**`mod_assign_get_submission_status` Web Service è¢« NYCU E3 ç³»çµ±ç®¡ç†å“¡åœç”¨æˆ–åˆªé™¤äº†**

é€™ä¸æ˜¯ä»£ç¢¼å•é¡Œï¼Œè€Œæ˜¯ E3 ç³»çµ±é…ç½®çš„è®Šæ›´ã€‚

---

## ğŸ“Š è¨ºæ–·éç¨‹å›é¡§

æˆ‘å€‘ç¶“æ­·äº†ä»¥ä¸‹è¨ºæ–·æ­¥é©Ÿï¼š

### 1. åˆæ­¥è¨ºæ–· (2dda941)
- æ·»åŠ äº† 14 å€‹è¨ºæ–·æª¢æŸ¥é»
- è¿½è¹¤ URL è§£æã€API è«‹æ±‚ã€æ•¸æ“šçµæ§‹
- **ç™¼ç¾**ï¼šæ‰€æœ‰ä½œæ¥­éƒ½é€šéåˆæ­¥éæ¿¾ï¼Œä½† `hasData` å§‹çµ‚ç‚º false

### 2. API éŸ¿æ‡‰åˆ†æ (4a797ec)
- æ·»åŠ å®Œæ•´ API éŸ¿æ‡‰ JSON è¼¸å‡º
- **ç™¼ç¾**ï¼šAPI è¿”å› `error: true` è€Œéé æœŸçš„æ•¸æ“šçµæ§‹

### 3. æ ¹æœ¬åŸå› ç¢ºèª
- æ‰€æœ‰ 9 å€‹ä½œæ¥­éƒ½è¿”å›ç›¸åŒçš„éŒ¯èª¤
- éŒ¯èª¤ä»£ç¢¼ï¼š`servicenotavailable`
- éŒ¯èª¤è¨Šæ¯ï¼šã€Œç¶²è·¯æœå‹™ç„¡æ³•ä½¿ç”¨(å®ƒä¸å­˜åœ¨æˆ–è€…å·²ç¶“åœç”¨)ã€

### 4. éŒ¯èª¤è™•ç†ä¿®å¾© (9fc43e6)
- æ·»åŠ  `data[0].error` æª¢æŸ¥
- åœ¨é¦–æ¬¡éŒ¯èª¤æ™‚è¼¸å‡ºæ¸…æ¥šçš„è­¦å‘Š
- ä½¿ç”¨ `break` è·³éæ‰€æœ‰å¾ŒçºŒæª¢æŸ¥

---

## âœ… å·²å®Œæˆçš„ä¿®å¾©

### 1. æäº¤ç‹€æ…‹åˆ¤æ–·é‚è¼¯ (8db2908)
- **ä¿®å¾©**: åªæœ‰ `status === 'submitted'` æ‰ç®—å·²ç¹³äº¤
- **ä½ç½®**: background.js:728-730

### 2. ä½œæ¥­ä¿ç•™é‚è¼¯ (8db2908)
- **ä¿®å¾©**: ä¿ç•™æ‰‹å‹•æ¨™è¨˜å’Œè‡ªå‹•æª¢æ¸¬çš„å·²ç¹³äº¤ä½œæ¥­
- **ä½ç½®**: background.js:553-556

### 3. URL è£œé½Šæ™‚æ©Ÿ (a33d1c6)
- **ä¿®å¾©**: åœ¨åˆä½µå‰è£œé½Š URLï¼Œæ‰“ç ´æ­»å¾ªç’°
- **ä½ç½®**: background.js:449-493

### 4. ç‹€æ…‹æŒä¹…åŒ– (8db2908)
- **ä¿®å¾©**: è‡ªå‹•æª¢æ¸¬ç‹€æ…‹ä¿å­˜åˆ° `assignmentStatuses`
- **ä½ç½®**: background.js:739-740

### 5. API éŒ¯èª¤è™•ç† (9fc43e6)
- **ä¿®å¾©**: æª¢æ¸¬ä¸¦è™•ç† API éŒ¯èª¤
- **ä½ç½®**: background.js:716-727

---

## ğŸ“ ç•¶å‰ç‹€æ…‹

### âœ… æ­£å¸¸é‹ä½œçš„åŠŸèƒ½

1. **ä½œæ¥­åŒæ­¥** - E3 API (`core_calendar_get_action_events_by_timesort`) æ­£å¸¸å·¥ä½œ
2. **èª²ç¨‹åŒæ­¥** - èª²ç¨‹åˆ—è¡¨ API æ­£å¸¸å·¥ä½œ
3. **æ‰‹å‹•æ¨™è¨˜** - ç”¨æˆ¶å¯ä»¥æ‰‹å‹•å°‡ä½œæ¥­æ¨™è¨˜ç‚ºã€Œå·²ç¹³äº¤ã€
4. **ä½œæ¥­ä¿ç•™** - å·²ç¹³äº¤ä½œæ¥­å³ä½¿éæœŸä¹Ÿæœƒä¿ç•™
5. **å…¬å‘Šå’Œä¿¡ä»¶** - æ•´åˆåŠŸèƒ½æ­£å¸¸
6. **AI ç¿»è­¯/æ‘˜è¦** - Gemini API åŠŸèƒ½æ­£å¸¸
7. **æˆç¸¾æŸ¥è©¢** - æˆç¸¾ API æ­£å¸¸

### âŒ ç„¡æ³•é‹ä½œçš„åŠŸèƒ½

1. **è‡ªå‹•æª¢æ¸¬ç¹³äº¤ç‹€æ…‹** - å›  `mod_assign_get_submission_status` API è¢«åœç”¨

---

## ğŸ”® æœªä¾†è§£æ±ºæ–¹æ¡ˆ

æœ‰ä¸‰å€‹å¯èƒ½çš„æ–¹å‘ï¼š

### æ–¹æ¡ˆ 1: ç­‰å¾… E3 é‡æ–°å•Ÿç”¨ API â³

**å„ªé»**:
- ç„¡éœ€ä¿®æ”¹ä»£ç¢¼
- æ•ˆèƒ½æœ€ä½³
- æœ€å¯é 

**ç¼ºé»**:
- ä¸çŸ¥é“ä½•æ™‚ï¼ˆæˆ–æ˜¯å¦ï¼‰æœƒé‡æ–°å•Ÿç”¨
- ç„¡æ³•ä¸»å‹•æ§åˆ¶

**å»ºè­°è¡Œå‹•**:
- å¯ä»¥å‘ NYCU è¨ˆä¸­åæ˜ é€™å€‹å•é¡Œ
- è©¢å•æ˜¯å¦æœ‰è¨ˆåŠƒé‡æ–°å•Ÿç”¨ `mod_assign_get_submission_status`

---

### æ–¹æ¡ˆ 2: HTML è§£ææ›¿ä»£æ–¹æ¡ˆ ğŸ”§

**å¯¦æ–½æ–¹å¼**:
```javascript
// 1. è¨ªå•ä½œæ¥­é é¢
const html = await fetchContentFromE3(assignment.url);

// 2. è§£æ HTML æŸ¥æ‰¾ç¹³äº¤ç‹€æ…‹æŒ‡ç¤ºå™¨
const submittedIndicators = [
  'å·²æäº¤ä¾›è©•åˆ†',
  'Submitted for grading',
  'submissionstatussubmitted',
  'ç¹³äº¤ç‹€æ…‹ï¼šå·²ç¹³äº¤',
  'Submission status: Submitted'
];

// 3. æª¢æŸ¥ä»»ä¸€æŒ‡ç¤ºå™¨æ˜¯å¦å­˜åœ¨
const isSubmitted = submittedIndicators.some(indicator =>
  html.includes(indicator)
);
```

**å„ªé»**:
- å®Œå…¨ç¨ç«‹æ–¼ API
- å¯ä»¥ç«‹å³å¯¦æ–½
- èˆ‡ E3 ç¶²é é¡¯ç¤ºä¸€è‡´

**ç¼ºé»**:
- æ•ˆèƒ½è¼ƒå·®ï¼ˆæ¯å€‹ä½œæ¥­éœ€è¦ä¸€æ¬¡ HTTP è«‹æ±‚ï¼‰
- éœ€è¦è§£æ HTMLï¼ˆè¼ƒä¸ç©©å®šï¼‰
- é é¢çµæ§‹è®Šæ›´æ™‚å¯èƒ½å¤±æ•ˆ
- å° E3 ä¼ºæœå™¨è² æ“”è¼ƒå¤§ï¼ˆ9 å€‹ä½œæ¥­ = 9 æ¬¡è«‹æ±‚ï¼‰

**é ä¼°æ•ˆèƒ½**:
- å–®å€‹ä½œæ¥­ï¼š~500msï¼ˆHTTP è«‹æ±‚ + HTML è§£æï¼‰
- 9 å€‹ä½œæ¥­ï¼ˆåºåˆ—ï¼‰ï¼š~4.5 ç§’
- å¯ä»¥ä½¿ç”¨ä¸¦è¡Œè«‹æ±‚ï¼ˆä½†éœ€è¦é™åˆ¶ä¸¦ç™¼æ•¸é¿å…éè¼‰ï¼‰

---

### æ–¹æ¡ˆ 3: åƒ…ä¾è³´æ‰‹å‹•æ¨™è¨˜ ğŸ‘¤

**å¯¦æ–½æ–¹å¼**:
- å®Œå…¨ç§»é™¤è‡ªå‹•æª¢æ¸¬åŠŸèƒ½
- åœ¨ç”¨æˆ¶ä»‹é¢ä¸­æ¸…æ¥šèªªæ˜éœ€è¦æ‰‹å‹•æ¨™è¨˜
- å„ªåŒ–æ‰‹å‹•æ¨™è¨˜çš„ç”¨æˆ¶é«”é©—

**å„ªé»**:
- ç„¡æ•ˆèƒ½é–‹éŠ·
- ç°¡å–®å¯é 
- ç”¨æˆ¶å®Œå…¨æŒæ§

**ç¼ºé»**:
- éœ€è¦ç”¨æˆ¶æ‰‹å‹•æ“ä½œ
- å¯èƒ½å¿˜è¨˜æ¨™è¨˜
- å¤±å»è‡ªå‹•åŒ–ä¾¿åˆ©æ€§

**UI æ”¹é€²å»ºè­°**:
- ä½œæ¥­ç¹³äº¤å¾Œè‡ªå‹•è·³å‡ºæ¨™è¨˜æé†’
- ä¸€éµæ¨™è¨˜æ‰€æœ‰å·²é€¾æœŸä½œæ¥­
- æ‰¹æ¬¡æ¨™è¨˜åŠŸèƒ½

---

## ğŸ’¡ æˆ‘çš„å»ºè­°

### çŸ­æœŸï¼ˆç¾åœ¨ï¼‰

**ä¿æŒç•¶å‰ç‹€æ…‹**ï¼š
- âœ… éŒ¯èª¤è™•ç†å·²æ·»åŠ ï¼Œä¸æœƒé‡è¤‡å˜—è©¦å¤±æ•—çš„ API
- âœ… æ‰‹å‹•æ¨™è¨˜åŠŸèƒ½å®Œæ•´å¯ç”¨
- âœ… æ‰€æœ‰å…¶ä»–åŠŸèƒ½æ­£å¸¸é‹ä½œ

ç”¨æˆ¶éœ€è¦ï¼š
1. ç¹³äº¤ä½œæ¥­å¾Œæ‰‹å‹•é»æ“Šã€Œå·²ç¹³äº¤ã€æŒ‰éˆ•
2. æˆ–åœ¨å´é‚Šæ¬„ä½œæ¥­åˆ—è¡¨ä¸­æ¨™è¨˜

---

### ä¸­æœŸï¼ˆ1-2 é€±å…§ï¼‰

**å¯¦æ–½ HTML è§£ææ›¿ä»£æ–¹æ¡ˆ**ï¼š

```javascript
// å½ä»£ç¢¼ç¤ºä¾‹
async function checkSubmissionViaHTML(assignment) {
  try {
    // è¨ªå•ä½œæ¥­é é¢
    const html = await fetchContentFromE3(assignment.url);

    // ç°¡å–®çš„é—œéµå­—æª¢æ¸¬
    const submitted = html.includes('å·²æäº¤ä¾›è©•åˆ†') ||
                     html.includes('Submitted for grading') ||
                     html.includes('submissionstatussubmitted');

    return submitted;
  } catch (error) {
    console.warn(`HTML è§£æå¤±æ•—: ${assignment.name}`, error);
    return null; // ç„¡æ³•ç¢ºå®šï¼Œä¿æŒåŸç‹€æ…‹
  }
}
```

**å¯¦æ–½è€ƒé‡**:
1. ä¸¦è¡Œè«‹æ±‚ï¼ˆæœ€å¤š 3 å€‹åŒæ™‚ï¼‰
2. éŒ¯èª¤è™•ç†ï¼ˆç¶²è·¯å¤±æ•—ã€HTML æ ¼å¼è®Šæ›´ï¼‰
3. å¿«å–æ©Ÿåˆ¶ï¼ˆé¿å…é‡è¤‡æª¢æŸ¥åŒä¸€ä½œæ¥­ï¼‰
4. ç”¨æˆ¶è¨­å®šï¼ˆå…è¨±åœç”¨è‡ªå‹•æª¢æ¸¬ä»¥ç¯€çœæµé‡ï¼‰

**é ä¼°é–‹ç™¼æ™‚é–“**: 2-4 å°æ™‚

---

### é•·æœŸï¼ˆæŒçºŒç›£æ§ï¼‰

1. **å®šæœŸæ¸¬è©¦ API å¯ç”¨æ€§**
   ```javascript
   // æ¯æ¬¡åŒæ­¥æ™‚æ¸¬è©¦ä¸€æ¬¡
   const apiAvailable = await testAPI('mod_assign_get_submission_status');
   if (apiAvailable) {
     // åˆ‡æ›å› API æ–¹å¼
   }
   ```

2. **èˆ‡ NYCU è¨ˆä¸­æºé€š**
   - è©¢å• API åœç”¨åŸå› 
   - è«‹æ±‚é‡æ–°å•Ÿç”¨æˆ–æä¾›æ›¿ä»£æ–¹æ¡ˆ
   - ç­è§£æœªä¾†è¨ˆåŠƒ

3. **æ¢ç´¢å…¶ä»– Moodle API**
   - `mod_assign_get_assignments` - å¯èƒ½åŒ…å«ç¹³äº¤ç‹€æ…‹
   - `mod_assign_list_participants` - å¯èƒ½åŒ…å«ç¹³äº¤è¨˜éŒ„
   - `mod_assign_get_user_mappings` - å¯èƒ½æœ‰ç›¸é—œè³‡æ–™

---

## ğŸ“ æŠ€è¡“ç­†è¨˜

### API æ¸¬è©¦ä»£ç¢¼

```javascript
// æ¸¬è©¦ API æ˜¯å¦å¯ç”¨
async function testMoodleAPI(methodname, args = {}) {
  const sesskey = await getSesskey();
  const url = `https://e3p.nycu.edu.tw/lib/ajax/service.php?sesskey=${sesskey}`;

  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify([{
      index: 0,
      methodname: methodname,
      args: args
    }])
  });

  const data = await response.json();
  return !(data && data[0] && data[0].error);
}

// ä½¿ç”¨ç¯„ä¾‹
const apiAvailable = await testMoodleAPI('mod_assign_get_submission_status', {
  assignid: 169048
});
console.log('API å¯ç”¨:', apiAvailable);
```

### HTML è§£æç¯„ä¾‹

```javascript
// æå–ç¹³äº¤ç‹€æ…‹
function extractSubmissionStatus(html) {
  // æ–¹æ³• 1: æŸ¥æ‰¾ç‰¹å®š CSS class
  if (html.includes('submissionstatussubmitted')) {
    return 'submitted';
  }

  // æ–¹æ³• 2: æŸ¥æ‰¾æ–‡å­—å…§å®¹
  const submittedPatterns = [
    /å·²æäº¤ä¾›è©•åˆ†/,
    /Submitted for grading/,
    /ç¹³äº¤ç‹€æ…‹[ï¼š:]\s*å·²ç¹³äº¤/,
    /Submission status[ï¼š:]\s*Submitted/
  ];

  for (const pattern of submittedPatterns) {
    if (pattern.test(html)) {
      return 'submitted';
    }
  }

  // æ–¹æ³• 3: æŸ¥æ‰¾ç‰¹å®š HTML çµæ§‹
  const submittedRegex = /<div[^>]*class="[^"]*submissionstatussubmitted[^"]*"[^>]*>/;
  if (submittedRegex.test(html)) {
    return 'submitted';
  }

  return 'pending';
}
```

---

## ğŸ¬ ä¸‹ä¸€æ­¥è¡Œå‹•

### çµ¦ç”¨æˆ¶

**ç¾åœ¨å¯ä»¥åšçš„**:
1. ç¹³äº¤ä½œæ¥­å¾Œæ‰‹å‹•é»æ“Šã€Œå·²ç¹³äº¤ã€æŒ‰éˆ•
2. å®šæœŸæª¢æŸ¥å´é‚Šæ¬„ä½œæ¥­åˆ—è¡¨
3. ç¹¼çºŒä½¿ç”¨å…¶ä»–æ‰€æœ‰åŠŸèƒ½ï¼ˆå…¬å‘Šã€æˆç¸¾ã€AI ç¿»è­¯ç­‰ï¼‰

**ç„¡éœ€åšçš„**:
- âŒ é‡æ–°å®‰è£æ“´å……åŠŸèƒ½
- âŒ æ¸…é™¤ç€è¦½å™¨å¿«å–
- âŒ é‡æ–°ç™»å…¥ E3

### çµ¦é–‹ç™¼è€…

**å¦‚æœè¦å¯¦æ–½ HTML è§£ææ–¹æ¡ˆ**:

1. **å‰µå»ºæ¸¬è©¦ç’°å¢ƒ**
   - æ”¶é›†ä¸åŒç¹³äº¤ç‹€æ…‹çš„ä½œæ¥­é é¢ HTML
   - å·²ç¹³äº¤ã€æœªç¹³äº¤ã€è‰ç¨¿ã€å·²è©•åˆ†ç­‰

2. **å¯¦ä½œè§£æé‚è¼¯**
   - åœ¨ `checkAssignmentSubmissionStatus` ä¸­æ·»åŠ  fallback
   - å…ˆå˜—è©¦ APIï¼Œå¤±æ•—å‰‡ç”¨ HTML è§£æ

3. **æ·»åŠ è¨­å®šé¸é …**
   - å…è¨±ç”¨æˆ¶é¸æ“‡ï¼šåƒ…æ‰‹å‹•/è‡ªå‹•æª¢æ¸¬ï¼ˆHTMLï¼‰/è‡ªå‹•æª¢æ¸¬ï¼ˆAPIï¼‰
   - æ·»åŠ æµé‡è­¦å‘Šæç¤º

4. **æ•ˆèƒ½å„ªåŒ–**
   - ä¸¦è¡Œè«‹æ±‚ï¼ˆé™åˆ¶ä¸¦ç™¼æ•¸ï¼‰
   - å¿«å–çµæœï¼ˆ24 å°æ™‚ï¼‰
   - åªæª¢æŸ¥æœªç¹³äº¤çš„ä½œæ¥­

5. **æ¸¬è©¦å’Œéƒ¨ç½²**
   - æ¸¬è©¦ä¸åŒèª²ç¨‹çš„ä½œæ¥­
   - æ¸¬è©¦ä¸­è‹±æ–‡é é¢
   - æ¸¬è©¦å„ç¨®ç¹³äº¤ç‹€æ…‹

---

## ğŸ“Š å®Œæ•´æäº¤æ­·å²

```bash
91ba5c6 docs: æ–°å¢é™¤éŒ¯ç‹€æ…‹ç¸½çµæ–‡ä»¶
cb6a04f docs: æ–°å¢è‡ªå‹•æª¢æ¸¬è¨ºæ–·æ—¥èªŒæŒ‡å—
2dda941 debug: æ·»åŠ å®Œæ•´çš„è‡ªå‹•æª¢æ¸¬æµç¨‹è¨ºæ–·æ—¥èªŒ
6da438a debug: æ·»åŠ è‡ªå‹•æª¢æ¸¬è·³éåŸå› çš„è©³ç´°æ—¥èªŒ
8e4327d debug: æ·»åŠ è©³ç´° URL è¨ºæ–·æ—¥èªŒä¸¦æ”¹é€²è£œé½Šæ¢ä»¶
a33d1c6 fix: åœ¨åˆä½µå‰è£œé½Šæ–°ä½œæ¥­ URLï¼Œç¢ºä¿è‡ªå‹•æª¢æ¸¬æ­£å¸¸å·¥ä½œ
53ac14d fix: è£œé½Šä½œæ¥­ URL ä»¥å•Ÿç”¨è‡ªå‹•æª¢æ¸¬ç¹³äº¤ç‹€æ…‹
8db2908 fix: ä¿®å¾©è‡ªå‹•æª¢æ¸¬çš„å·²ç¹³äº¤ä½œæ¥­ä¸è¢«ä¿ç•™çš„å•é¡Œ
4a797ec debug: æ·»åŠ  API å®Œæ•´éŸ¿æ‡‰æ—¥èªŒ
9fc43e6 fix: è™•ç† mod_assign_get_submission_status API ä¸å¯ç”¨çš„éŒ¯èª¤
```

---

## ğŸ™ çµè«–

é›–ç„¶è‡ªå‹•æª¢æ¸¬åŠŸèƒ½å›  E3 ç³»çµ±é…ç½®è€Œç„¡æ³•ä½¿ç”¨ï¼Œä½†æˆ‘å€‘ï¼š

1. âœ… **å¾¹åº•è¨ºæ–·äº†å•é¡Œ** - ä¸æ˜¯ä»£ç¢¼ bugï¼Œè€Œæ˜¯ API è¢«åœç”¨
2. âœ… **ä¿®å¾©äº†å¤šå€‹å…¶ä»– bug** - ä¿ç•™é‚è¼¯ã€URL è£œé½Šã€ç‹€æ…‹æŒä¹…åŒ–
3. âœ… **æ·»åŠ äº†å®Œå–„çš„éŒ¯èª¤è™•ç†** - ä¸æœƒé‡è¤‡å˜—è©¦å¤±æ•—çš„æ“ä½œ
4. âœ… **æä¾›äº†æ›¿ä»£æ–¹æ¡ˆ** - HTML è§£æä½œç‚º fallback
5. âœ… **å„ªåŒ–äº†è¨ºæ–·æµç¨‹** - æœªä¾†å•é¡Œæ›´å®¹æ˜“è¿½è¹¤

æ“´å……åŠŸèƒ½çš„å…¶ä»–æ‰€æœ‰åŠŸèƒ½éƒ½æ­£å¸¸é‹ä½œï¼Œæ‰‹å‹•æ¨™è¨˜æ˜¯ç›®å‰å¯é çš„è§£æ±ºæ–¹æ¡ˆã€‚

å¦‚æœéœ€è¦å¯¦æ–½ HTML è§£ææ–¹æ¡ˆï¼Œéš¨æ™‚å¯ä»¥é–‹å§‹é–‹ç™¼ï¼

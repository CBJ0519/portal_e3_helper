# 自動檢測診斷日誌指南

## 目的
這份文件說明 v2dda941 版本中新增的詳細診斷日誌，用於追蹤自動檢測作業繳交狀態的完整流程。

## 如何查看日誌

1. 開啟 Chrome 擴充功能頁面：`chrome://extensions/`
2. 找到「NYCU E3 Helper」，點擊「重新載入」按鈕
3. 點擊「Service Worker」連結，開啟 Service Worker Console
4. 執行一次同步（點擊側邊欄的「🔄 同步」按鈕）
5. 查看 Console 中的日誌

## 診斷日誌內容

當自動檢測作業繳交狀態時，會依序顯示以下日誌：

### 1. 檢測開始
```
E3 Helper: 自動檢測開始檢查 N 個作業...
```
- 顯示總共有多少個作業需要檢查

### 2. 作業過濾（針對每個作業）

#### 跳過手動作業
```
E3 Helper: 跳過手動作業 - [作業名稱] (ID: [作業ID])
```

#### 跳過無效 URL 作業
```
E3 Helper: 跳過無效 URL 作業 - [作業名稱] (ID: [作業ID]), URL: [URL或'無']
```

#### 準備檢查作業
```
E3 Helper: 準備檢查作業 - [作業名稱] (ID: [作業ID])
```

### 3. URL 解析（關鍵診斷點）
```
E3 Helper: URL 解析 - [作業名稱], cmid: [課程模組ID], URL: [完整URL]
```
- **cmid** 是關鍵參數，必須成功提取才能檢查繳交狀態
- 如果 cmid 為 null，表示 URL 解析失敗

#### 無 cmid 作業
```
E3 Helper: 跳過無 cmid 作業 - [作業名稱] (ID: [作業ID])
```

### 4. API 請求
```
E3 Helper: 發送繳交狀態檢查請求 - [作業名稱], cmid: [課程模組ID]
```

### 5. API 響應
```
E3 Helper: API 響應狀態 - [作業名稱], status: [HTTP狀態碼], ok: [true/false]
```
- status 應該是 200
- ok 應該是 true

### 6. 數據結構驗證
```
E3 Helper: API 數據結構 - [作業名稱], hasData: [true/false]
```
- hasData 應該是 true，表示 API 返回了有效數據

### 7. 繳交狀態判斷

#### 檢測到已繳交
```
E3 Helper: 檢測到作業已繳交 - [作業名稱] (ID: [作業ID])
```

#### 之前檢測為已繳交，現在顯示未繳交
```
E3 Helper: 作業 [作業名稱] 之前檢測為已繳交，但現在顯示未繳交，保持原狀態
```

#### 一般狀態
```
E3 Helper: 作業 [作業名稱] 繳交狀態: [已繳交/未繳交], 當前狀態: [submitted/pending]
```

### 8. 檢查成功
```
E3 Helper: 成功檢查作業 - [作業名稱], checkedCount: [已檢查數量]
```
- **checkedCount** 會逐步增加
- 最終應該等於成功檢查的作業數量

### 9. 錯誤處理
```
E3 Helper: 檢查作業 [作業名稱] 繳交狀態失敗: [錯誤訊息]
```

### 10. 檢測完成
```
E3 Helper: 繳交狀態檢查完成 - 已檢查 N 個作業，其中 M 個已繳交
```
- N = 成功檢查的作業數量
- M = 檢測到已繳交的作業數量

## 常見問題診斷

### 問題：「已檢查 0 個作業」

可能的原因（依序檢查日誌）：

1. **所有作業都被跳過**
   - 檢查是否有「跳過手動作業」或「跳過無效 URL 作業」訊息
   - 如果所有作業都是手動新增，則不會自動檢測

2. **cmid 提取失敗**
   - 檢查「URL 解析」日誌
   - 如果 cmid 為 null，表示 URL 格式不正確
   - 正確的 URL 應包含 `mod/assign/view.php?id=數字`

3. **API 請求失敗**
   - 檢查「API 響應狀態」日誌
   - 如果 status 不是 200 或 ok 為 false，表示 API 請求失敗
   - 可能原因：未登入、網路問題、sesskey 過期

4. **數據結構無效**
   - 檢查「API 數據結構」日誌
   - 如果 hasData 為 false，表示 API 返回的數據結構不符合預期
   - 可能原因：API 格式變更、作業類型不支援

5. **try-catch 捕捉到異常**
   - 檢查是否有「檢查作業 XXX 繳交狀態失敗」的錯誤訊息
   - 查看錯誤的詳細內容

### 問題：部分作業未檢查

檢查日誌中該作業的狀態：
- 如果有「準備檢查作業」但沒有「成功檢查作業」，表示檢查過程中出錯
- 查看該作業之後是否有錯誤訊息

### 問題：已繳交的作業沒有被檢測到

檢查日誌中的「繳交狀態」訊息：
- 如果顯示「未繳交」，可能原因：
  - 作業狀態為 'new'（草稿）而非 'submitted'
  - 需要手動提交而非僅保存草稿

## 測試流程

1. **確認擴充功能已更新**
   ```
   git pull
   chrome://extensions/ → 重新載入
   ```

2. **執行同步**
   - 開啟側邊欄
   - 點擊「🔄 同步」按鈕

3. **查看完整日誌**
   - 從「自動檢測開始檢查」開始
   - 到「繳交狀態檢查完成」結束
   - 複製完整日誌以供分析

4. **重點關注**
   - URL 解析：cmid 是否成功提取
   - API 響應：status 和 ok 的值
   - 數據結構：hasData 的值
   - checkedCount：是否正確遞增

## 版本資訊

- **版本**: 2dda941
- **提交訊息**: debug: 添加完整的自動檢測流程診斷日誌
- **修改檔案**: background.js (lines 665-769)
- **相關修復**:
  - a33d1c6: 在合併前補齊新作業 URL
  - 8db2908: 修復作業保留邏輯
  - 53ac14d: 補齊作業 URL 以啟用自動檢測

## 預期結果

正常情況下，日誌應顯示：
```
E3 Helper: 自動檢測開始檢查 9 個作業...
E3 Helper: 準備檢查作業 - Challenge 3 (ID: 52204)
E3 Helper: URL 解析 - Challenge 3, cmid: 16984, URL: https://e3p.nycu.edu.tw/mod/assign/view.php?id=16984
E3 Helper: 發送繳交狀態檢查請求 - Challenge 3, cmid: 16984
E3 Helper: API 響應狀態 - Challenge 3, status: 200, ok: true
E3 Helper: API 數據結構 - Challenge 3, hasData: true
E3 Helper: 作業 Challenge 3 繳交狀態: 已繳交, 當前狀態: submitted
E3 Helper: 成功檢查作業 - Challenge 3, checkedCount: 1
[... 其他作業 ...]
E3 Helper: 繳交狀態檢查完成 - 已檢查 9 個作業，其中 5 個已繳交
```

任何與此不符的情況都表示檢測流程中存在問題，診斷日誌會明確指出問題位置。
